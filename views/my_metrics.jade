extend layout

block content
  div.container
    div.header.clearfix
         nav
                    ul(class='nav nav-pills pull-right')
                        li(role='presentation')
                            a(href='/')
                                i(class="fa fa-home")
                                span  Index
                        if locals.connected == true
                            li(role='presentation',class="active")
                                a(href='/my-metrics')
                                    i(class="fa fa-table")
                                    span  My metrics
                            li(role='presentation')
                                a(href='/logout')
                                    i(class="fa fa-sign-out")
                                    span  Logout [ #{locals.user} ]

    div.jumbotron



        h1
            i(class="fa fa-pie-chart")
            span  My metrics

        div#display-metrics


        h1
            i(class="fa fa-plus")
            span  Insert metrics
        p You can insert metrics using this form.
        form(name="login", action="/my-metrics", method="post")
            div.row
                div.col-sm-6
                    div#datepicker
                    input(type="text", name="date", id="date", class="form-control", required="true")

                div.col-sm-6
                    div.form-group
                      label(for="user") Value
                      input(type="number", name="value", id="value", class="form-control",required="true")
                    div.form-group
                      button(type="submit", class="btn btn-success") Insert this metric



  script
    :coffee-script
      $('#get-metrics').click (e) ->
        e.preventDefault()
        $.getJSON 'http://localhost:1889/data.tsv', (data) ->
          $('#content').empty()
          c = "<table class=\"table table-bordered table-hover\"><thead><tr><th>TIMESTAMP</th><th>VALUE</th></tr></thead><tbody>"
          for metric in data
            c += "<tr><td>timestamp: #{metric.timestamp}</td><td>value: #{metric.value}</td></tr>"
            c += "</tbody></table>"
          $('#content').append c

      $('#datepicker').datepicker
        maxViewMode: 1
        todayHighlight: true
        format: 'dd/mm/yyyy'

      margin =
        top: 20
        right: 20
        bottom: 30
        left: 30
      width = 600 - (margin.left) - (margin.right)
      height = 300 - (margin.top) - (margin.bottom)
      parseDate = d3.time.format('%d-%b-%y').parse
      x = d3.time.scale().range([
        0
        width
      ])
      y = d3.scale.linear().range([
        height
        0
      ])
      xAxis = d3.svg.axis().scale(x).orient('bottom')
      yAxis = d3.svg.axis().scale(y).orient('left')
      line = d3.svg.line().x((d) ->
        x d.date
      ).y((d) ->
        y d.close
      )
      svg = d3.select('#display-metrics').append('svg').attr('width', width + margin.left + margin.right).attr('height', height + margin.top + margin.bottom).append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
      d3.tsv 'http://localhost:1889/data.tsv', (error, data) ->
        if error
          throw error
        data.forEach (d) ->
          d.date = parseDate(d.date)
          d.close = +d.close
          return
        x.domain d3.extent(data, (d) ->
          d.date
        )
        y.domain d3.extent(data, (d) ->
          d.close
        )
        svg.append('g').attr('class', 'x axis').attr('transform', 'translate(0,' + height + ')').call xAxis
        svg.append('g').attr('class', 'y axis').call(yAxis).append('text').attr('transform', 'rotate(-90)').attr('y', 6).attr('dy', '.71em').style('text-anchor', 'end').text 'Price ($)'
        svg.append('path').datum(data).attr('class', 'line').attr 'd', line
        return